.docker_tests:
  image: docker:27.3.1
  services:
    - docker:27.3.1-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
    DOCKER_HOST: tcp://docker:2375
    DOCKER_DRIVER: overlay2
  script:
    # SANDBOX
    - echo "Testing deployment/sandbox.yaml..."
    - docker compose -f deployment/sandbox.yaml config
    - docker compose -f deployment/sandbox.yaml up -d --build
    - docker compose -f deployment/sandbox.yaml ps
    - docker compose -f deployment/sandbox.yaml down -v

    # PRODUCTION
    - echo "Testing deployment/production.yaml..."
    - docker compose -f deployment/production.yaml config
    - docker compose -f deployment/production.yaml up -d
    - docker compose -f deployment/production.yaml ps
    - docker compose -f deployment/production.yaml down -v
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_PIPELINE_SOURCE == "merge_request_event"'
